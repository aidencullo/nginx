name: Run Nginx Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  nginx:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install nginx
      run: |
        sudo apt-get update
        sudo apt-get install -y nginx

    - name: Copy nginx config
      run: |
        sudo cp nginx.conf /etc/nginx/nginx.conf

    - name: Build React app
      run: |
        cd my-app
        npm install
        npm run build

    - name: Copy dist to nginx docroot
      run: |
        sudo mkdir -p /opt/local/share/nginx/html
        sudo cp -r my-app/dist/* /opt/local/share/nginx/html/

    - name: Test nginx config
      run: |
        sudo nginx -t

    - name: Start nginx
      run: |
        sudo systemctl start nginx

    - name: Check nginx status
      run: |
        sudo systemctl status nginx

    - name: Test React app is rendered
      run: |
        curl http://localhost | grep "Vite + TypeScript"
